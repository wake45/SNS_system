<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>프로필 페이지</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-b from-slate-800 to-slate-600 text-white min-h-screen p-4">

  <div class="max-w-3xl mx-auto bg-white text-black rounded-xl shadow-lg p-6">
    <!-- 프로필 영역 -->
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <img
          src="{{user.profile.profile_picture}}"
          alt="프로필 사진"
          class="w-20 h-20 rounded-full border-2 border-blue-400 {{#if isMyPage}}cursor-pointer{{else}}cursor-default{{/if}}"
          {{#if isMyPage}}onclick="handleProfileClick()"{{/if}}
          id="profileImage"
        />
        {{#if isMyPage}}
          <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileChange(event)">
        {{/if}}        
        <div>
          <h2 class="text-xl font-semibold">{{user.profile.name}}</h2>
          <p class="text-gray-600">{{user.profile.bio}}</p>
          <div class="flex gap-4 mt-1">
            <button onclick="handleFollowerClick()" class="text-blue-500 hover:underline">
              팔로워: <span id="followerCount">{{user.followers.length}}</span>명
            </button>
            <button onclick="handleFollowingClick()" class="text-blue-500 hover:underline">
              팔로잉: <span id="followingCount">{{user.following.length}}</span>명
            </button>
          </div>
        </div>
      </div>
      <!-- 본인 계정일 경우 로그아웃 버튼, 다른 계정일 경우 채팅 버튼 -->
      <div>
        <button class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400" onclick="goHome()">홈화면</button>
        {{#if isMyPage}}
          <button class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400" onclick="logout()">로그아웃</button>
        {{else}}
          <button class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400" onclick="startChat()">채팅</button>
        {{/if}}
      </div>
    </div>

    <!-- 피드를 표시할 컨테이너 -->
    <div id="feedContainer" class="grid grid-cols-3 gap-4 mt-6">
      <!-- 피드 항목들이 이곳에 동적으로 추가됩니다 -->
    </div>

    <!-- 글쓰기 / 팔로우 버튼 -->
    <div class="mt-6">
      <button id="writeOrFollowButton" class="w-full py-3 bg-gray-300 rounded-md hover:bg-gray-400" onclick="{{#if isMyPage}}writePost(){{else}}handleFollow(){{/if}}">
        {{#if isMyPage}}피드작성{{else}}팔로우하기{{/if}}
      </button>
    </div>
  </div>

  <!-- 모달 구조 -->
  <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900"></h3>
        <div id="modalContent" class="mt-2 px-7 py-3" style="color: black;">
          <!-- 팔로워 또는 팔로잉 목록이 여기에 삽입됩니다 -->
        </div>
        <div class="items-center px-4 py-3">
          <button id="closeModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
            닫기
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 피드 상세 모달 -->
  <div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-900">피드</h3>
        <button id="deleteFeedButton" class="bg-gray-300 px-3 py-1 rounded shadow" onclick="deleteFeed()">삭제</button>
      </div>
      <img id="detailModalImage" src="" alt="상세 이미지" class="w-full h-64 object-cover rounded mb-4" />
      <div class="flex justify-around mb-2">
        <div class="flex flex-col items-center">
          <button class="bg-blue-200 px-4 py-1 rounded-full mb-1" onclick="handleLike()" id="likeButton">좋아요</button>
          <span id="likeCount" class="text-sm text-gray-700"></span>
        </div>
        <div class="flex flex-col items-center">
          <button class="bg-blue-200 px-4 py-1 rounded-full mb-1" disabled>댓글</button>
          <span id="commentCount" class="text-sm text-gray-700"></span>
        </div>
      </div>
      <div class="text-sm text-gray-600 mt-2">
        <span id="createdAt" class="block text-center"></span>
      </div>
      <p id="feedContent" class="mt-4 text-gray-800 text-center"></p>
      <div class="mt-4">
        <button id="detailCloseModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">
          닫기
        </button>
      </div>
    </div>
  </div>

  <script>
    let loadedFeeds = []; // 피드 데이터

    // 모달 요소 가져오기
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    // 모달 닫기 버튼 설정
    const closeModal = document.getElementById('closeModal');
    closeModal.onclick = function() {
      modal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetch('/feed/user')
        .then(response => response.json())
        .then(feeds => {
          loadedFeeds = feeds; // 전역에 저장

          const feedContainer = document.getElementById('feedContainer');
          feeds.forEach(feed => {
            const feedItem = document.createElement('div');
            feedItem.className = 'relative';
            feedItem.innerHTML = `
              <img src="${feed.image_url}" alt="피드 이미지" class="w-full h-48 object-cover cursor-pointer" onclick="showDetail('${feed.id}')">
            `;
            feedContainer.appendChild(feedItem);
          });
        })
        .catch(error => console.error('피드를 불러오는 중 오류 발생:', error));
    });

    function deleteFeed(feedId) {
      fetch(`/feed/${feedId}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      })
      .then(response => {
        if (response.ok) {
          alert('피드가 성공적으로 삭제되었습니다.');
          location.reload(); // 페이지 새로고침
        } else {
          response.json().then(data => {
            alert(data.message || '피드 삭제 중 오류가 발생했습니다.');
          });
        }
      })
      .catch(error => {
        console.error('삭제 요청 중 오류 발생:', error);
        alert('피드 삭제 중 오류가 발생했습니다.');
      });
    };

    function showDetail(feedId) {
      const feed = loadedFeeds.find(f => f.id === feedId);
      if (!feed) {
        console.error('피드를 찾을 수 없습니다:', feedId);
        return;
      }

      document.getElementById('detailModalImage').src = feed.image_url;
      document.getElementById('feedContent').textContent = feed.content;
      document.getElementById('createdAt').textContent = new Date(feed.created_at).toLocaleDateString('ko-KR');
      document.getElementById('likeCount').textContent = `${feed.likes.length}명`;
      document.getElementById('commentCount').textContent = `${feed.comments.length}개`;

      const deleteFeedButton = document.getElementById('deleteFeedButton');
      deleteFeedButton.onclick = () => deleteFeed(feedId);

      const likeButton = document.getElementById('likeButton');
      likeButton.disabled = false;
      likeButton.textContent = '좋아요';
      likeButton.onclick = () => handleLike(feedId);

      document.getElementById('detailModal').classList.remove('hidden');
    }

    // 피드 상세 모달 닫기
    document.getElementById('detailCloseModal').addEventListener('click', function() {
      document.getElementById('detailModal').classList.add('hidden');
    });

    // 프로필 이미지를 클릭했을 때 파일 선택 창 열기
    function handleProfileClick() {
      document.getElementById('fileInput').click();
    }

    // 프로필 이미지 변경
    function handleFileChange(event) {
      const file = event.target.files[0];

      if (file) {
        if (!file.type.startsWith('image/')) {
          alert('이미지 파일을 선택해주세요.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);

        // 서버로 이미지와 사용자 ID를 함께 업로드 요청
        const formData = new FormData();
        formData.append('profileImage', file);        

        fetch('/user/upload', {
          method: 'POST',
          body: formData,
        })
        .then(response => response.json())
        .then(data => {
          console.log('서버 응답:', data);
          // 서버에서 반환한 이미지 URL을 프로필 이미지로 설정
          location.reload(); // 페이지 새로고침
        })
        .catch(error => {
          console.error('업로드 실패:', error);
        });
      }
    }

    // 팔로워 버튼 클릭 시 호출되는 함수
    function handleFollowerClick(followerIds) {
      fetch('/user/get-usernames', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userIds: followerIds }),
      })
        .then(response => response.json())
        .then(data => {
          if (Array.isArray(data)) {
            if (data.usernames.length === 0) {
              displayModal('팔로워 목록', '팔로워가 없습니다.');
            } else {
              const content = data.usernames.map(username => `<p>${username}</p>`).join('');
              displayModal('팔로워 목록', content);
            }
          }
          else {
            displayModal('팔로워 목록', '팔로워가 없습니다.');
          }
        })
        .catch(error => console.error('팔로워 목록을 불러오는 중 오류 발생:', error));
    }

    // 팔로잉 버튼 클릭 시 호출되는 함수
    function handleFollowingClick(followingIds) {
      fetch('/user/get-usernames', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userIds: followingIds }),
      })
        .then(response => response.json())
        .then(data => {
          if (Array.isArray(data)) {
            if (data.usernames.length === 0) {
              displayModal('팔로잉 목록', '팔로잉하는 사용자가 없습니다.');
            } else {
              const content = data.usernames.map(username => `<p>${username}</p>`).join('');
              displayModal('팔로잉 목록', content);
            }
          } else {
            displayModal('팔로잉 목록', '팔로잉하는 사용자가 없습니다.');
          }
        })
        .catch(error => console.error('팔로잉 목록을 불러오는 중 오류 발생:', error));
    }

    // 모달 창에 데이터 표시
    function displayModal(title, content) {
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      modalTitle.innerText = title;
      modalContent.innerHTML = content;
      const modal = document.getElementById('modal');
      modal.style.display = 'block';
    }

    function writePost() {
      window.location.href = '/create-feed.html';
    }

    function handleLike(feedId) {
      fetch(`/feed/${feedId}/like`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
      })
      .then(response => response.json())
      .then(data => {
        if (data.message === '좋아요가 추가되었습니다.') {
          alert('좋아요를 눌렀습니다.');
          location.reload(); // 페이지 새로고침
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('좋아요 처리 중 오류 발생:', error);
      });
    }

    function handleFollow() {
      alert("팔로우 기능 실행");
    }

    function startChat() {
      alert("채팅 시작");
    }

    function logout() {
      fetch('/auth/logout', {
        method: 'POST',
        credentials: 'same-origin' // 쿠키를 포함하여 요청을 보냅니다.
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url; // 리디렉션된 URL로 이동
        } else {
          alert('로그아웃에 실패했습니다.');
        }
      })
      .catch(error => {
        console.error('로그아웃 중 오류 발생:', error);
      });
    }
  </script>
</body>
</html>